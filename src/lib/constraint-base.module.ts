
import { Context, freeContract, ModuleFlux, Pipe} from '@youwol/flux-core'
import { ArchFacade } from './arche.facades';


export namespace ConstraintBase {

    //Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>
    export let svgIcon = `<g xmlns="http://www.w3.org/2000/svg"><path d="m15 512h181c6.134 0 11.649-3.734 13.927-9.429l8.228-20.571h278.845c8.284 0 15-6.716 15-15v-270c0-8.284-6.716-15-15-15h-76v-29.922h.069c19.022 0 36.567-1.19 48.428-12.959 7.633-7.573 11.503-18.38 11.503-32.119 0-36.74-29.208-107-75-107s-75 70.26-75 107c0 13.739 3.87 24.546 11.503 32.119 11.876 11.783 29.444 12.963 48.497 12.959v29.922h-75c-6.134 0-11.649 3.734-13.927 9.429l-8.228 20.571h-142.845v-29.922h.069c19.022 0 36.567-1.19 48.428-12.959 7.633-7.573 11.503-18.38 11.503-32.119 0-39.68-31.053-106-75-106-44.206 0-75 66.789-75 106 0 13.739 3.87 24.546 11.503 32.119 11.875 11.783 29.447 12.961 48.497 12.958v29.923h-106c-8.284 0-15 6.716-15 15v270c0 8.284 6.716 15 15 15zm467-60h-251.845l12.553-31.383c4.209.922 8.624 1.383 13.292 1.383 22.578 0 34.795-10.859 43.716-18.789 7.595-6.751 12.612-11.211 23.784-11.211s16.189 4.46 23.784 11.211c8.921 7.93 21.138 18.789 43.716 18.789 22.454 0 34.43-10.338 44.052-18.646 7.92-6.837 13.152-11.354 24.448-11.354 10.53 0 15.594 3.964 22.5 10.072zm-118.367-334.177c-2.176-2.159-2.633-7.077-2.633-10.823 0-29.706 24.57-77 45-77s45 47.294 45 77c0 3.746-.457 8.664-2.633 10.823-4.486 4.451-20.333 4.326-34.315 4.218-2.635-.021-13.469-.021-16.104 0-13.983.109-29.829.233-34.315-4.218zm-37.478 94.177h155.845v64.304c-6.154-2.577-13.502-4.304-22.5-4.304-22.454 0-34.43 10.338-44.052 18.646-7.92 6.837-13.152 11.354-24.448 11.354-11.172 0-16.189-4.46-23.784-11.211-8.921-7.93-21.138-18.789-43.716-18.789-9.333 0-16.892 1.858-23.183 4.595 8.722-21.796 16.272-40.678 25.838-64.595zm-26.439 101.211c7.595-6.751 12.612-11.211 23.784-11.211s16.189 4.46 23.784 11.211c8.921 7.93 21.138 18.789 43.716 18.789 22.454 0 34.43-10.338 44.052-18.646 7.92-6.837 13.152-11.354 24.448-11.354 10.53 0 15.594 3.964 22.5 10.072v54.232c-6.154-2.577-13.502-4.304-22.5-4.304-22.454 0-34.43 10.338-44.052 18.646-7.92 6.837-13.152 11.354-24.448 11.354-11.172 0-16.189-4.46-23.784-11.211-8.921-7.93-21.138-18.789-43.716-18.789s-34.795 10.859-43.716 18.789c-7.595 6.751-12.612 11.211-23.784 11.211-.635 0-1.238-.02-1.826-.047l25.986-64.965c8.361-3.842 14.455-9.242 19.556-13.777zm-206.083-165.388c-2.176-2.159-2.633-7.077-2.633-10.823 0-29.32 24.57-76 45-76s45 46.68 45 76c0 3.746-.457 8.664-2.633 10.823-4.486 4.451-20.332 4.328-34.315 4.218-2.635-.021-13.469-.021-16.104 0-13.983.107-29.829.233-34.315-4.218zm-63.633 94.177h251.845l-35.415 88.537c-5.29-1.834-9.194-5.285-14.214-9.748-8.921-7.93-21.138-18.789-43.716-18.789s-34.795 10.859-43.716 18.789c-7.595 6.751-12.612 11.211-23.784 11.211-11.296 0-16.528-4.517-24.448-11.354-9.622-8.308-21.598-18.646-44.052-18.646-8.998 0-16.346 1.728-22.5 4.304zm0 100.072c6.906-6.108 11.97-10.072 22.5-10.072 11.296 0 16.528 4.517 24.448 11.354 9.622 8.308 21.598 18.646 44.052 18.646 22.578 0 34.795-10.859 43.716-18.789 7.595-6.751 12.612-11.211 23.784-11.211s16.189 4.46 23.784 11.211c5.703 5.069 12.758 11.331 22.999 15.192l-16.714 41.786c-7.483-4.577-17.052-8.189-30.069-8.189-22.578 0-34.795 10.859-43.716 18.789-7.595 6.751-12.612 11.211-23.784 11.211-11.296 0-16.528-4.517-24.448-11.354-9.622-8.307-21.598-18.646-44.052-18.646-8.998 0-16.346 1.728-22.5 4.304zm0 90c6.906-6.108 11.97-10.072 22.5-10.072 11.296 0 16.528 4.517 24.448 11.354 9.622 8.307 21.598 18.646 44.052 18.646 22.578 0 34.795-10.859 43.716-18.789 7.595-6.751 12.612-11.211 23.784-11.211 8.487 0 13.423 2.578 18.635 6.775-25.069 62.673-17.829 44.571-21.29 53.225h-155.845z"/></g>`

    

    export interface ConfigConstraintBase {

        emitInitialValue: boolean
    }

    export abstract class Module<TConfig extends ConfigConstraintBase> extends ModuleFlux {

        output$: Pipe<ArchFacade.Constraint>

        constructor(params) {
            super(params)

            this.addInput( {
                id:"config", 
                description:`Triggerring this input construct a surface constraint to use in Arch computations.
                The constraint is entirely defined by the module configuration.`,
                contract: freeContract(),
                onTriggered: ({data, configuration, context}) => this.emitConstraint(data, configuration, context) 
            })
            this.output$ = this.addOutput({id:"constraint"})
            if (this.getPersistentData<TConfig>().emitInitialValue)
                this.emitConstraint(undefined, this.getPersistentData<TConfig>(), new Context("", {}))
        }

        abstract createConstraint(config: TConfig): ArchFacade.Constraint

        emitConstraint(_, config: TConfig, context: Context) {
            let c = this.createConstraint(config)
            this.output$.next({ data: c, context })
        }
    }
}
